---
title: Preview Environment Setup
subtitle: Configure your Flightcontrol project to create a preview environment on each pull request.
---

## About The Feature

Flightcontrolâ€™s Preview Environment feature is an alternative to long-lived staging environments. 

When configured, Flightcontrol will automatically create an ephemeral environment for each pull request or merge request. 

Here's an example of how it will look like in the Flightcontrol dashboard once it's configured and there are opened pull requests:

<img src="https://res.cloudinary.com/djp21wtxm/image/upload/v1665398938/i1600x513-JIMfKyHDx-DF_jbqctm.png" />


## **Currently Supported Services**

- âœ…Â  Fargate
- âœ…Â  Fargate-worker

> âš ï¸Â **RDS** and **static** service types are not yet supported. Make sure to omit these from the preview environment config in flightcontrol.json (see below)

In the meantime for database, you can use a separate staging database and add the connection string to preview environments as an env variable.
> 

## Configuration

**With GUI**

Click the following button at the bottom of any Projectâ€™s page in the Flightcontrol dashboard. Then add the services and environment variables you want for preview environments.

<img src="https://res.cloudinary.com/djp21wtxm/image/upload/v1665398974/i1600x541-UOlXpzXm_ED6_e02h4f.png" />



**With flightcontrol.json**

Add a new `Environment` to your environments array, with the following `source` object:

- *Required*:
    - `pr: true`
- *Optional*:
    - `filter.toBranches: string[]`
        - Example: `"toBranches": ["main"]`
        - If set, only pull or merge requests to the specified branch(es) will be deployed as preview environments. If omitted, all pull requests will be deployed.
    - `filter.labels: string[]`
        - Example: `"labels": ["deploy-preview"]`
        - If set, only pull or merge requests with at least one of the specified labels will be deployed. It will be deployed when the label is added, whether thatâ€™s during PR creation or some time after the PR is opened.

<aside>
ðŸ’¡ Note that our optional filters work with an `AND` logic. If both filters are enabled, we will only deploy a PR that matches both the target branch(es) (`toBranches`) and one of the labels configured (`labels`).

</aside>

- Example of preview environment:
    
    ```json
    {
      "environments": [
        ...existing environments,
        {
          "source": { 
    				// With this configuration, ready-for-review PRs
            // targetting `main` and with the `deploy` label will 
            // trigger a deploy in Flightcontrol
            "pr": true,
            "filter": {
              "toBranches": ["main"],
              // optional label filter:
    					"labels": ["deploy"]
            }
          },
          "services": [
            ...your fargate config
            // âš ï¸Â **RDS** and **static** service types are not yet supported
          ]
          ...rest of env config
        }
      ]
    }
    ```
    
- Example using database from a separate staging environment:

```json
{
  "environments": [
    ...existing environments,
		{ // This environment will have the database
      "id": "staging",
      "name": "Staging",
      "region": "us-west-2",
      "source": {
        "branch": "main"
      },
      "services": [
        ...other services,
        {
          "id": "database-xuorBu",
          "name": "Database",
          "port": 5432,
          "type": "rds",
          "engine": "postgres",
          "private": false,
          "storage": 20,
          "maxStorage": 100,
          "instanceSize": "db.t2.micro",
          "engineVersion": "12",
          "deletionProtection": false,
          "applyChangesImmediately": false,
          "autoUpgradeMinorVersions": true,
        }
      ]
    },
    { // This is the environment for enabling preview environment
      "source": {
        "pr": true,
        "filter": {
          "toBranches": ["main"],
        }
      },
      "services": [
         {
          ...your fargate config
          "envVariables": {
            "DATABASE_URL": {
              "fromParameterStore": "parameter.store.name.for.your.RDS"
            }
          },
         }
        // âš ï¸Â **RDS** and **static** service types are not yet supported
      ]
      ...rest of env config
    }
  ]
}
```

## Lifecycle

**Creation**

A preview environment will be created when:

- a pull request matches your configuration (the target branch and labels filters if any)
- and when it is not in `draft` mode.

**New Deployment**

Each new push to a branch that is currently opened in a Pull Request will trigger a new deployment.

**Destroy**

Your preview environment will be destroyed when:

- the pull request is merged â€” destroyed immediately
- the pull request is closed but not merged â€” destroyed after 30 mins, in case it was accidentally closed.

> Pull requests opened in **Draft** state will not be deployed until they are marked â€œready for reviewâ€. If you donâ€™t like this, let us know!
> 

## Limitations

Preview environments are not intended for production workloads. 

To reduce your resource cost and to increase speed of provisioning, they donâ€™t support the following features:

1. No CDN
2. No custom domains (every service and PR will have a Flightcontrol subdomain created automatically for it)
3. No horizontal scaling or load balancing, services with servers will only have a single instance

## **Good to Know**

**First deployment time**

All the preview environments will share AWS resources. What this means in term of deployment time is that the very first time a pull request is created, it will take a bit longer to create the preview environment but subsequent pull requests will skip this step. The time for build and deploy will be the same. 

**Github Comment**

Flightcontrol will keep you updated of the deployment with a Github comment added to the corresponding pull request. This comment will inform you of the progress and once successful, it will display the URL for you preview environment. It should look something like this:

<img src="https://res.cloudinary.com/djp21wtxm/image/upload/v1665399029/i1600x359-c2QcgQgn-WUf_jwonlh.png" />

You can also check the Flightcontrol dashboard to see information about the preview environment.

**Preview URL**

You'll be able to get the preview URL once a preview environment has been fully deployed. This URL can be retrieved in the Flightcontrol dashboard as well as in the Github comment in your PR. 

## AWS Costs

- Constant
    - When you have preview environments enabled, there are a number of AWS resources that are configured all the time, even if you are not making pull requests. We do this (1) to speed up provisioning of an environment for each PR and (2) reduce incremental costs for each preview environment.
    - The main long-running AWS resource is a single load balancer (per service configured under your environment) that manages traffic for all your preview environments. This AWS cost is around $20/month.
- Variable
    - Each service on each preview environment will have an associated cost, same as normal environments.
    - AWS only charges you based on the time the services are running. So if the preview environment for a specific PR is only running for 2 days, then youâ€™re only charged for 2 days of usage.

## Advanced Topics

### VPC

By default, a new, single VPC is used for all preview environments.

Alternatively, you can deploy preview environments to an existing VPC by setting the `vpc` field in `flightcontrol.json`.